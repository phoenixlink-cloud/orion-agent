version: "3.9"

services:
  # -------------------------------------------------------------------------
  # Egress Proxy — The Narrow Door (HOST-SIDE, Phase 2)
  # -------------------------------------------------------------------------
  # Filters ALL outbound traffic from the Orion sandbox.
  # Runs on the egress network (internet access) and the internal network
  # (reachable by sandbox containers). Sandbox containers can ONLY reach
  # the internet through this proxy.
  #
  # AEGIS config is mounted read-only from the host — Orion cannot modify it.
  # Audit logs are written to a host-side volume — Orion cannot delete them.
  # -------------------------------------------------------------------------
  egress-proxy:
    build:
      context: ..
      dockerfile: docker/Dockerfile.egress
    ports:
      - "${EGRESS_PORT:-8888}:8888"
    environment:
      - EGRESS_PROXY_PORT=8888
      - EGRESS_CONFIG_PATH=/etc/orion/egress_config.yaml
      - EGRESS_AUDIT_LOG=/var/log/orion/egress_audit.log
    volumes:
      # AEGIS egress config — READ-ONLY mount from host
      - ${ORION_HOME:-~/.orion}/egress_config.yaml:/etc/orion/egress_config.yaml:ro
      # Audit logs — writable, but on host-side volume (Orion can't reach)
      - egress-audit:/var/log/orion
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8888/", "-o", "/dev/null", "||", "true"]
      interval: 15s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
    networks:
      - orion-egress   # Has internet access (for forwarding allowed traffic)
      - orion-internal  # Reachable by sandbox containers

  # -------------------------------------------------------------------------
  # Backend — FastAPI + WebSocket API (SANDBOX)
  # -------------------------------------------------------------------------
  # Runs inside the Docker sandbox. All outbound traffic is routed through
  # the egress proxy via HTTP_PROXY / HTTPS_PROXY environment variables.
  # This container has NO direct internet access.
  # -------------------------------------------------------------------------
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "${API_PORT:-8000}:8000"
    env_file:
      - ../.env
    environment:
      - PORT=8000
      - WORKERS=1
      - LOG_LEVEL=info
      # Route all outbound traffic through the egress proxy
      - HTTP_PROXY=http://egress-proxy:8888
      - HTTPS_PROXY=http://egress-proxy:8888
      - NO_PROXY=localhost,127.0.0.1
    volumes:
      - orion-data:/home/orion/.orion
      # Google OAuth credentials — READ-ONLY mount (Phase 2)
      # - ${ORION_HOME:-~/.orion}/google_credentials.json:/home/orion/.orion/google_credentials.json:ro
    depends_on:
      egress-proxy:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    networks:
      - orion-internal  # Internal only — NO direct internet access
    dns:
      # Use the egress proxy's DNS filter (Phase 2.2)
      # For now, use Docker's default DNS
      - 127.0.0.11

  # -------------------------------------------------------------------------
  # Frontend — Next.js Web UI
  # -------------------------------------------------------------------------
  web:
    build:
      context: ../orion-web
      dockerfile: ../docker/Dockerfile.web
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      - NEXT_PUBLIC_WS_URL=ws://localhost:${API_PORT:-8000}/ws/chat
      - NEXT_PUBLIC_API_URL=http://localhost:${API_PORT:-8000}
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - orion-internal

volumes:
  orion-data:
  egress-audit:

networks:
  # Internal network — sandbox containers only, NO internet access
  orion-internal:
    driver: bridge
    internal: true  # KEY: This prevents direct internet access
  # Egress network — only the proxy has internet access through this
  orion-egress:
    driver: bridge
